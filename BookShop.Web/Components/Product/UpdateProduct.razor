@page "/product/edit/{id:int}"

@using BookShop.Models;
@using BookShop.Web.Interfaces;
@using BookShop.Web.Services;
@inject IProductService ProductService
@inject NotificationService NotificationService
@inject NavigationManager NavigationManager
@inject ICategoryService CategoryService

<RadzenTemplateForm TItem="Product" Data=@product Submit=@Submit InvalidSubmit="@InvalidSubmit">
    <RadzenFieldset Text="Add product">
        <div class="row mb-5">
            <div class="col-md-4">
                <RadzenLabel Text="Name" />
            </div>
            <div class="col">
                <RadzenTextBox style="display: block" Name="Name" @bind-Value=@product.Name class="w-100" />
                <RadzenRequiredValidator Component="Name" Text="Name is required" Popup=true Style="position: absolute" />
                <RadzenCustomValidator Component="Name" Validator="@(()=>NameValidator(product.Name))" Text="Name already exists" />
            </div>
        </div>

        <div class="row mb-5">
            <div class="col-md-4">
                <RadzenLabel Text="Author" />
            </div>
            <div class="col">
                <RadzenTextBox style="display: block" Name="Author" @bind-Value=@product.Author class="w-100" />
            </div>
        </div>

        <div class="row mb-5">
            <div class="col-md-4">
                <RadzenLabel Text="Category ID" />
            </div>
            <div class="col">
                <RadzenDropDown Name="CategoryId" @bind-Value=@product.CategoryId Data=@Categories TextProperty="Name" ValueProperty="Id" Style="width: 100%; max-width: 400px;" />
                <RadzenCustomValidator Component="CategoryId" Validator="@(()=>product.CategoryId!=default)" Text="Category is required" Popup=true />
            </div>
        </div>

        <div class="row mb-5">
            <div class="col-md-4">
                <RadzenLabel Text="Publisher" />
            </div>
            <div class="col">
                <RadzenTextBox style="display: block;" Name="Publisher" @bind-Value=@product.Publisher class="w-100" />
                <RadzenRequiredValidator Component="Publisher" Text="Publisher is required" Popup=true Style="position: absolute" />
            </div>
        </div>

        <div class="row mb-5">
            <div class="col-md-4">
                <RadzenLabel Text="Publishing year" />
            </div>
            <div class="col">
                <RadzenNumeric Name="Publishing year" @bind-Value=@product.PublishingYear class="w-100" />
            </div>
        </div>

        <div class="row mb-5">
            <div class="col-md-4">
                <RadzenLabel Text="Price" />
            </div>
            <div class="col">
                <RadzenNumeric Name="Price" @bind-Value=@product.Price class="w-100" />
                <RadzenRequiredValidator Component="Price" Text="Price is required" Popup=true Style="position: absolute" />
            </div>
        </div>

        <div class="row mb-5">
            <div class="col-md-4">
                <RadzenLabel Text="QuantityInStock" />
            </div>
            <div class="col">
                <RadzenNumeric Name="QuantityInStock" @bind-Value=@product.QuantityInStock class="w-100" />
                <RadzenRequiredValidator Component="QuantityInStock" Text="Quantity is required" Popup=true Style="position: absolute" />
            </div>
        </div>

        <RadzenButton ButtonType="ButtonType.Submit" Text="Submit"></RadzenButton>
        <RadzenButton Text="Cancel" Click="Cancel"></RadzenButton>
    </RadzenFieldset>
</RadzenTemplateForm>

@code {
    [Parameter]
    public int id { get; set; }
    public Product product { get; set; } = new();
    public List<Category>? Categories;
    string name="";
    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        product = await ProductService.GetProduct(id);
        name = product.Name;
        Categories = await CategoryService.GetCategories();
    }
    async Task Submit(Product product)
    {
        var isSuccess= await ProductService.UpdateProduct(id, product);
        if (isSuccess)
        {
            NotificationService.Notify(NotificationSeverity.Success, "Success!", "Updated succesfuly.");
            NavigationManager.NavigateTo("/products");
        }
        else
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error!", "Could not update.");
        }

    }
    bool NameValidator(string name_)
    {
        if (name_ == name) return true;
        var checker = ProductService.ValidateName(name_);
        return !checker;
    }

    void InvalidSubmit() => NotificationService.Notify(NotificationSeverity.Error, "Error!", "Invalid data.");
    void Cancel() => NavigationManager.NavigateTo("/products", true);

}